<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Game Night - Controller</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
  <div id="app" class="min-h-screen p-4 flex items-center justify-center"></div>

  <script>
    const SERVER_URL = 'https://family-game-night-bbv8.onrender.com';
    const socket = io(SERVER_URL);

    let state = {
      screen: 'JOIN', // JOIN, LOBBY, PLAYING, WAITING
      roomCode: '',
      playerName: '',
      playerId: '',
      selectedAvatar: 'üéÆ',
      gameMode: null,
      currentQuestion: null,
      hasBuzzed: false,
      selectedAnswer: null,
      score: 0,
      feedback: null
    };

    const avatars = ['üéÆ', 'üéØ', '‚ö°', 'üî•', '‚≠ê', 'üé™', 'üöÄ', 'üëæ', 'üé®', 'üíé', 'üåü', 'üé≠'];

    // Socket events
    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('joined_room', (data) => {
      if (data.success) {
        state.screen = 'LOBBY';
        render();
      }
    });

    socket.on('game_started', (data) => {
      state.gameMode = data.game;
      state.screen = 'PLAYING';
      render();
    });

    socket.on('new_question', (data) => {
      state.currentQuestion = data.question;
      state.hasBuzzed = false;
      state.selectedAnswer = null;
      state.feedback = null;
      state.screen = 'PLAYING';
      render();
    });

    socket.on('answer_result', (data) => {
      state.score = data.totalScore;
      state.feedback = data.correct ? 'correct' : 'incorrect';
      state.screen = 'WAITING';
      render();
      
      // Show feedback animation
      setTimeout(() => {
        state.feedback = null;
        render();
      }, 2000);
    });

    socket.on('round_end', () => {
      state.screen = 'WAITING';
      render();
    });

    socket.on('error', (data) => {
      alert(data.message);
    });

    // Actions
    function joinGame() {
      if (!state.roomCode || !state.playerName) return;
      
      state.playerId = 'player_' + Date.now();
      
      socket.emit('join_room', {
        roomCode: state.roomCode.toUpperCase(),
        playerId: state.playerId,
        playerName: state.playerName,
        avatar: state.selectedAvatar
      });
    }

    function buzzIn() {
      if (state.hasBuzzed) return;
      
      state.hasBuzzed = true;
      socket.emit('buzz_in', { playerId: state.playerId });
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([50, 50, 50]);
      }
      
      render();
    }

    function submitAnswer(answer) {
      state.selectedAnswer = answer;
      socket.emit('submit_answer', { 
        playerId: state.playerId, 
        answer 
      });
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
      
      state.screen = 'WAITING';
      render();
    }

    // Render
    function render() {
      const app = document.getElementById('app');
      
      if (state.screen === 'JOIN') {
        app.innerHTML = renderJoin();
      } else if (state.screen === 'LOBBY') {
        app.innerHTML = renderLobby();
      } else if (state.screen === 'PLAYING') {
        app.innerHTML = renderPlaying();
      } else if (state.screen === 'WAITING') {
        app.innerHTML = renderWaiting();
      }
    }

    function renderJoin() {
      return `
        <div class="w-full max-w-md space-y-6 animate-fade-in">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">‚ú®</div>
            <h1 class="text-4xl font-black mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
              JOIN GAME
            </h1>
            <p class="text-purple-300">Enter the room code from your TV</p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-2 text-purple-300">Room Code</label>
              <input
                id="roomCode"
                type="text"
                value="${state.roomCode}"
                oninput="state.roomCode = this.value.toUpperCase(); this.value = state.roomCode"
                placeholder="COOL-1234"
                class="w-full px-6 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl text-2xl font-bold text-center tracking-wider focus:border-purple-400 focus:outline-none text-white"
                maxlength="9"
              />
            </div>

            <div>
              <label class="block text-sm font-bold mb-2 text-purple-300">Your Name</label>
              <input
                id="playerName"
                type="text"
                value="${state.playerName}"
                oninput="state.playerName = this.value"
                placeholder="Enter your name"
                class="w-full px-6 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl text-xl focus:border-purple-400 focus:outline-none text-white"
                maxlength="20"
              />
            </div>

            <div>
              <label class="block text-sm font-bold mb-2 text-purple-300">Choose Your Avatar</label>
              <div class="grid grid-cols-6 gap-2">
                ${avatars.map(avatar => `
                  <button
                    onclick="state.selectedAvatar = '${avatar}'; render()"
                    class="p-3 text-3xl rounded-xl transition-all ${
                      state.selectedAvatar === avatar 
                        ? 'bg-purple-600 scale-110' 
                        : 'bg-white/10 hover:bg-white/20'
                    }">
                    ${avatar}
                  </button>
                `).join('')}
              </div>
            </div>

            <button
              onclick="joinGame()"
              class="w-full py-5 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-xl font-black text-xl transition-all transform active:scale-95 shadow-lg ${
                !state.roomCode || !state.playerName ? 'opacity-50 cursor-not-allowed' : ''
              }">
              JOIN GAME üöÄ
            </button>
          </div>
        </div>
      `;
    }

    function renderLobby() {
      return `
        <div class="w-full max-w-md text-center space-y-8 animate-fade-in">
          <div class="text-8xl mb-4">${state.selectedAvatar}</div>
          <h2 class="text-4xl font-black">${state.playerName}</h2>
          <div class="bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
            <div class="animate-pulse text-2xl mb-4">‚è≥</div>
            <p class="text-xl text-purple-300">Waiting for host to start the game...</p>
          </div>
          <div class="bg-purple-600/20 backdrop-blur rounded-xl p-4 border border-purple-400/30">
            <p class="text-sm text-purple-300">Room: <span class="font-bold text-white">${state.roomCode}</span></p>
          </div>
        </div>
      `;
    }

    function renderPlaying() {
      if (!state.currentQuestion) {
        return `
          <div class="text-center">
            <div class="animate-pulse text-4xl mb-4">‚è≥</div>
            <p class="text-xl">Loading question...</p>
          </div>
        `;
      }

      if (!state.hasBuzzed) {
        return `
          <div class="w-full max-w-md space-y-6 animate-fade-in">
            <div class="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20 text-center">
              <div class="text-6xl mb-2">${state.selectedAvatar}</div>
              <p class="text-xl font-bold">${state.playerName}</p>
              <p class="text-3xl font-black text-yellow-400 mt-2">${state.score} pts</p>
            </div>

            <button
              onclick="buzzIn()"
              class="w-full h-64 bg-gradient-to-br from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-3xl font-black text-6xl transition-all transform active:scale-95 shadow-2xl flex items-center justify-center">
              <div class="text-center">
                <div class="text-8xl mb-2">‚ö°</div>
                <div>BUZZ!</div>
              </div>
            </button>

            <p class="text-center text-purple-300 text-sm">Tap to buzz in first!</p>
          </div>
        `;
      }

      return `
        <div class="w-full max-w-md space-y-4 animate-fade-in">
          <div class="bg-green-600/20 backdrop-blur rounded-2xl p-4 border border-green-400 text-center">
            <div class="text-4xl mb-2">‚úÖ</div>
            <p class="text-lg font-bold">You buzzed in! Select your answer:</p>
          </div>

          <div class="space-y-3">
            ${state.currentQuestion.choices.map((choice, idx) => `
              <button
                onclick="submitAnswer('${choice}')"
                class="w-full p-5 rounded-xl font-bold text-lg transition-all transform active:scale-95 ${
                  state.selectedAnswer === choice
                    ? 'bg-purple-600 scale-105'
                    : 'bg-white/10 hover:bg-white/20'
                } ${state.selectedAnswer !== null ? 'cursor-not-allowed opacity-50' : ''}">
                ${choice}
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderWaiting() {
      return `
        <div class="w-full max-w-md text-center space-y-6 animate-fade-in">
          ${state.feedback === 'correct' ? `
            <div class="bg-green-500/20 backdrop-blur rounded-2xl p-8 border-2 border-green-400">
              <div class="text-6xl mb-4">üéâ</div>
              <h3 class="text-3xl font-black text-green-400 mb-2">CORRECT!</h3>
              <p class="text-xl">Nice work!</p>
            </div>
          ` : state.feedback === 'incorrect' ? `
            <div class="bg-red-500/20 backdrop-blur rounded-2xl p-8 border-2 border-red-400">
              <div class="text-6xl mb-4">üòÖ</div>
              <h3 class="text-3xl font-black text-red-400 mb-2">WRONG!</h3>
              <p class="text-xl">Better luck next time</p>
            </div>
          ` : `
            <div class="bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
              <div class="animate-pulse text-4xl mb-4">‚è≥</div>
              <p class="text-xl text-purple-300">Waiting for next question...</p>
            </div>
          `}

          <div class="bg-purple-600/20 backdrop-blur rounded-xl p-6 border border-purple-400/30">
            <div class="text-6xl mb-2">${state.selectedAvatar}</div>
            <p class="text-xl font-bold mb-1">${state.playerName}</p>
            <p class="text-3xl font-black text-yellow-400">${state.score} pts</p>
          </div>
        </div>
      `;
    }

    // Initial render
    render();
  </script>
</body>
</html>